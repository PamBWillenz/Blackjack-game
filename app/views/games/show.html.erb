<div id="game-container" class="game-container">
  <h1 class="game-heading">Blackjack Game</h1>
  <p id="game-id" class="game-id">Game ID: <%= @game.id %></p>

  <div id="betting-section" class="mb-8">
    <%# Show betting UI and Deal button only when no cards are present (start of round) %>
    <% if show_betting?(@game) %>
    <h2 id="betting-title" class="betting-title">Place Your Bet</h2>
    <% player = @game.player %>
    <div class="player-bet-container">
      <span class="player-name-label"><%= player&.name || 'Player' %></span>
      <%= turbo_frame_tag dom_id(player || @game, :bet) do %>
      <%= render partial: 'players/player_bet', locals: { player: player } %>
      <% end %>
    </div>

    <%# Show Deal Cards button when the game has no cards (start the round).
          The button is visible so users can start the round, but it's disabled until
          every non-dealer player has placed a bet. %>
    <%= turbo_frame_tag dom_id(@game, :deal_button) do %>
    <%= render partial: 'games/deal_button', locals: { game: @game } %>
    <% end %>
    <% end %>

    <%# Show New Game button only when the round is over (kept outside betting UI)
        so it's available after the round completes regardless of cards presence. %>
    <% if show_new_game?(@game) %>
    <div class="new-game-btn-container">
      <button data-controller="new-round" data-new-round-game-id-value="<%= @game.id %>" data-action="click->new-round#startNewRound" class="btn-deal btn-new">New Game</button>
    </div>
    <% end %>
  </div>

  <% if show_cards?(@game) %>
  <%# Single-player rendering: show player then dealer %>
  <% ordered = [@game.player, @game.dealer].compact %>
  <% ordered.each do |p| %>
  <div class="player-card">
    <h2 class="player-name"><%= p.is_dealer ? "Dealer" : p.name %>
      <% unless p.is_dealer %>
      <span class="player-balance">&nbsp;â€” Balance: $<%= p.balance %></span>
      <% end %>
    </h2>

    <div class="player-cards-container">
      <% p.cards.each do |card| %>
      <% if p.is_dealer && !card.face_up %>
      <div class="card-back"><span>ðŸ‚ </span></div>
      <% else %>
      <div class="card-front">
        <span class="card-rank"><%= card.rank %></span>
        <span class="card-suit <%= suit_color_class(card.suit) %>"><%= suit_symbol(card.suit) %></span>
      </div>
      <% end %>
      <% end %>
    </div>

    <% if p.is_dealer %>
    <p class="hand-value">Hand Value: <span class="hand-value-number"><%= dealer_visible_value(p, @game) %></span><% if !@game.player_done? %> (visible)<% end %></p>
    <% if @game.game_over? %>
    <% if @game.dealer_winner? %>
    <span class="winner-badge">Winner!</span>
    <% elsif @game.bust?(p) %>
    <span class="bust">Bust!</span>
    <% end %>
    <% end %>
    <% else %>
    <p class="hand-value">Hand Value: <span class="hand-value-number"><%= p.hand_value %></span></p>
    <% if @game.game_over? && (p.standing || @game.bust?(p)) %>
    <% badge = result_badge_for(p, @game) %>
    <% if badge.present? %>
    <span class="<%= badge == 'Winner!' ? 'winner-badge' : badge == 'Tie!' ? 'tie-badge' : 'bust' %>"><%= badge %></span>
    <% end %>
    <% end %>
    <% end %>

    <div class="player-action-btns">
      <% if !p.is_dealer && !p.standing %>
      <%= button_to "Hit", hit_game_path(@game, player_id: p.id), method: :post, class: "btn-action btn-hit" %>
      <%= button_to "Stand", stand_game_path(@game, player_id: p.id), method: :post, class: "btn-action btn-stand" %>
      <% else %>
      &nbsp;
      <% end %>
    </div>
  </div>
  <% end %>
  <% end %>