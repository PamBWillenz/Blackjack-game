<div id="game-container" class="game-container">
  <h1 class="game-heading">Blackjack Game</h1>
  <p id="game-id" class="game-id">Game ID: <%= @game.id %></p>

  <div id="betting-section" class="mb-8">
    <h2 id="betting-title" class="betting-title">Place Your Bet</h2>
    <% @game.players.where(is_dealer: false).each do |player| %>
    <div class="player-bet-container">
      <span class="player-name-label"><%= player.name %></span>
      <%= turbo_frame_tag dom_id(player, :bet) do %>
      <%= render partial: 'players/player_bet', locals: { player: player } %>
      <% end %>
    </div>
    <% end %>
    <%# Show Deal Cards button when the game has no cards (start the round).
        The button is visible so users can start the round, but it's disabled until
        every non-dealer player has placed a bet. %>
    <% if @game.cards.empty? %>
    <%= turbo_frame_tag dom_id(@game, :deal_button) do %>
    <%= render partial: 'games/deal_button', locals: { game: @game } %>
    <% end %>
    <% end %>

    <%# Show New Game button only when the round is over %>
    <% if @game.game_over? %>
    <div class="new-game-btn-container" style="margin-top:8px;">
      <%= button_to "New Game", new_game_path, method: :get, class: "btn-deal btn-new" %>
    </div>
    <% end %>
  </div>

  <% if @game.cards.any? %>
  <%# Render non-dealer players first, then dealer last to avoid swapping positions in the UI %>
  <% non_dealers = @game.players.where(is_dealer: false).to_a %>
  <% dealer_player = @game.players.find_by(is_dealer: true) %>
  <% ordered_players = non_dealers + [dealer_player].compact %>
  <% ordered_players.each do |player| %>
  <div class="player-card">
    <h2 class="player-name"><%= player.is_dealer ? "Dealer" : player.name %></h2>
    <div class="player-cards-container">
      <% player.cards.each do |card| %>
      <% if player.is_dealer && !card.face_up %>
      <div class="card-back">
        <span>üÇ†</span>
      </div>
      <% else %>
      <div class="card-front">
        <span class="card-rank"><%= card.rank %></span>
        <span class="card-suit">
          <% if card.suit == 'Hearts' %>‚ô•Ô∏è<% elsif card.suit == 'Diamonds' %>‚ô¶Ô∏è<% elsif card.suit == 'Clubs' %>‚ô£Ô∏è<% elsif card.suit == 'Spades' %>‚ô†Ô∏è<% end %>
        </span>
      </div>
      <% end %>
      <% end %>
    </div>

    <% if player.is_dealer %>
    <%# Show only visible dealer hand value until all players are done %>
    <% if @game.players_done? %>
    <p class="hand-value">Hand Value: <span class="hand-value-number"><%= player.hand_value %></span></p>
    <% if @game.game_over? %>
    <% if @game.dealer_winner? %>
    <span class="winner-badge">Winner!</span>
    <% elsif @game.bust?(player) %>
    <span class="bust">Bust!</span>
    <% end %>
    <% end %>
    <% else %>
    <p class="hand-value">Hand Value: <span class="hand-value-number"><%= player.visible_hand_value %></span> (visible)</p>
    <% end %>
    <% else %>
    <p class="hand-value">Hand Value: <span class="hand-value-number"><%= player.hand_value %></span></p>
    <% if @game.game_over? && (player.standing || @game.bust?(player)) %>
    <% if @game.winner?(player) %>
    <span class="winner-badge">Winner!</span>
    <% elsif @game.tie?(player) %>
    <span class="tie-badge">Tie!</span>
    <% elsif @game.bust?(player) %>
    <span class="bust">Bust!</span>
    <% end %>
    <% end %>
    <% end %>

    <%# duplicate Bust display removed; badges are handled above per-player %>
    <div class="player-action-btns" style="min-height:48px; display:flex; align-items:center; gap:8px;">
      <% if !player.is_dealer && !player.standing %>
      <%= button_to "Hit", hit_game_path(@game, player_id: player.id), method: :post, class: "btn-action btn-hit" %>
      <%= button_to "Stand", stand_game_path(@game, player_id: player.id), method: :post, class: "btn-action btn-stand" %>
      <% else %>
      &nbsp;
      <% end %>
    </div>
  </div>
  <% end %>
  <% end %>